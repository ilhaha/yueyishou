package com.ilhaha.yueyishou.rules;

import com.ilhaha.yueyishou.model.form.order.ServiceFeeRuleRequestForm;
import com.ilhaha.yueyishou.model.vo.order.ServiceFeeRuleResponseVo;
import java.math.BigDecimal;
import java.math.RoundingMode;

/**
 * 估算订单金额和顾客缴纳平台费用
 *
 * 订单总金额 = 回收品类单价 * 用户选择的总量最大值
 *
 * 顾客缴纳平台费用1 = 100 > 订单总金额  (订单总金额 * 1%)
 * 顾客缴纳平台费用2 = 100 <= 订单总金额 < 1000 (订单总金额 * 3%)
 * 顾客缴纳平台费用3 = 1000 <= 订单总金额 < 2000 (订单总金额 * 5 %)
 * 顾客缴纳平台费用4 = 3000 <= 订单总金额 < 4000 (订单总金额 * 7 %)
 * 顾客缴纳平台费用5 = 4000 <= 订单总金额 < 5000 (订单总金额 * 10 %)
 * 顾客缴纳平台费用6 = 订单总金额 >= 5000 (订单总金额 * 15 %)
 */

rule "Calculate Service Fees"
when
    $request : ServiceFeeRuleRequestForm($unitPrice : unitPrice, $recycleWeigh : recycleWeigh)
    $response : ServiceFeeRuleResponseVo()
then
    // 计算订单总金额并四舍五入到两位小数
    BigDecimal totalAmount = $unitPrice.multiply($recycleWeigh)
                                       .setScale(2, RoundingMode.HALF_UP);

    // 初始化平台费用
    BigDecimal platformFee = BigDecimal.ZERO;

    // 根据订单总金额计算平台费用
    if (totalAmount.compareTo(BigDecimal.valueOf(100)) < 0) {
        platformFee = totalAmount.multiply(BigDecimal.valueOf(0.01));
    } else if (totalAmount.compareTo(BigDecimal.valueOf(100)) >= 0 && totalAmount.compareTo(BigDecimal.valueOf(1000)) < 0) {
        platformFee = totalAmount.multiply(BigDecimal.valueOf(0.03));
    } else if (totalAmount.compareTo(BigDecimal.valueOf(1000)) >= 0 && totalAmount.compareTo(BigDecimal.valueOf(2000)) < 0) {
        platformFee = totalAmount.multiply(BigDecimal.valueOf(0.05));
    } else if (totalAmount.compareTo(BigDecimal.valueOf(3000)) >= 0 && totalAmount.compareTo(BigDecimal.valueOf(4000)) < 0) {
        platformFee = totalAmount.multiply(BigDecimal.valueOf(0.07));
    } else if (totalAmount.compareTo(BigDecimal.valueOf(4000)) >= 0 && totalAmount.compareTo(BigDecimal.valueOf(5000)) < 0) {
        platformFee = totalAmount.multiply(BigDecimal.valueOf(0.10));
    } else if (totalAmount.compareTo(BigDecimal.valueOf(5000)) >= 0) {
        platformFee = totalAmount.multiply(BigDecimal.valueOf(0.15));
    }

    // 四舍五入平台费用并保留两位小数
    platformFee = platformFee.setScale(2, RoundingMode.HALF_UP);

    // 设置顾客预支付平台订单金额
    $response.setExpectCustomerPlatformAmount(platformFee);
end